{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥–∞–º–∏ - Library Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- –°–≤–æ–¥–∫–∞ -->
    <div class="row mb-4">
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary mb-3">
                        <span class="fs-2">üìö</span><br>
                        –í—Å–µ–≥–æ –∫–Ω–∏–≥
                    </h5>
                    <p class="card-text display-6 mb-0">{{ total_books }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-success mb-3">
                        <span class="fs-2">üìñ</span><br>
                        –í—Å–µ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
                    </h5>
                    <p class="card-text display-6 mb-0">{{ total_copies }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning mb-3">
                        <span class="fs-2">üìò</span><br>
                        –í—ã–¥–∞–Ω–æ
                    </h5>
                    <p class="card-text display-6 mb-0">{{ borrowed_copies }}</p>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–∏—Å–∫ -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-primary text-white">
                            <i class="fas fa-search">üîç</i>
                        </span>
                        <input type="text" 
                               class="form-control border-primary" 
                               id="searchInput" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞–≤—Ç–æ—Ä—É..."
                               value="{{ search_query }}">
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bookModal">
                        ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–Ω–∏–≥ -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                    <th>–ê–≤—Ç–æ—Ä</th>
                    <th>–¢–µ–º–∞—Ç–∏–∫–∞</th>
                    <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th>–î–æ—Å—Ç—É–ø–Ω–æ/–í—Å–µ–≥–æ</th>
                    <th>–°—Ä–µ–¥–Ω—è—è —Ü–µ–Ω–∞</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for book in books %}
                <tr>
                    <td>{{ book.title }}</td>
                    <td>{{ book.author }}</td>
                    <td>{{ book.theme or '‚Äî' }}</td>
                    <td>{{ book.description }}</td>
                    <td>{{ book.available_copies }}/{{ book.total_copies }}</td>
                    <td>
                        {% if book.avg_price > 0 %}
                            {{ book.avg_price }} ‚ÇΩ
                        {% else %}
                            <span class="text-muted">‚Äî</span>
                        {% endif %}
                    </td>
                    <td>
                        <button class="btn btn-sm btn-primary" 
                                onclick='editBook({{ book.id }}, {{ book.title|tojson }}, {{ book.author|tojson }}, {{ book.description|tojson }}, {{ book.theme|tojson if book.theme else "null"|tojson }})' 
                                data-bs-toggle="tooltip" 
                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            ‚úèÔ∏è
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteBook({{ book.id }})" data-bs-toggle="tooltip" title="–£–¥–∞–ª–∏—Ç—å">üóëÔ∏è</button>
                        <button class="btn btn-sm btn-warning" onclick="managePurchases({{ book.id }})" data-bs-toggle="tooltip" title="–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫—É–ø–∫–∞–º–∏">üì¶</button>
                        <a href="/books/{{ book.id }}/qrcodes" class="btn btn-sm btn-info" data-bs-toggle="tooltip" title="QR –∫–æ–¥—ã">üîç</a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="?page=1&search={{ search_query }}" aria-label="First">
                    <span aria-hidden="true">¬´¬´</span>
                </a>
            </li>
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="?page={{ current_page - 1 }}&search={{ search_query }}" aria-label="Previous">
                    <span aria-hidden="true">¬´</span>
                </a>
            </li>
            
            {% for page in range(max(1, current_page - 2), min(total_pages + 1, current_page + 3)) %}
            <li class="page-item {% if page == current_page %}active{% endif %}">
                <a class="page-link" href="?page={{ page }}&search={{ search_query }}">{{ page }}</a>
            </li>
            {% endfor %}
            
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="?page={{ current_page + 1 }}&search={{ search_query }}" aria-label="Next">
                    <span aria-hidden="true">¬ª</span>
                </a>
            </li>
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="?page={{ total_pages }}&search={{ search_query }}" aria-label="Last">
                    <span aria-hidden="true">¬ª¬ª</span>
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–∏–≥–∏ -->
<div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="modalTitle">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="bookForm">
                <div class="modal-body">
                    <input type="hidden" id="bookId" name="id">
                    <div class="mb-3">
                        <label class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" class="form-control" id="title" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ê–≤—Ç–æ—Ä</label>
                        <input type="text" class="form-control" id="author" name="author" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–¢–µ–º–∞—Ç–∏–∫–∞</label>
                        <select class="form-select" id="theme" name="theme" required>
                            <option value="">–í—ã–±–µ—Ä–∏—Ç–µ —Ç–µ–º–∞—Ç–∏–∫—É</option>
                            <option value="–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞">–•—É–¥–æ–∂–µ—Å—Ç–≤–µ–Ω–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</option>
                            <option value="–ù–∞—É—á–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞">–ù–∞—É—á–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</option>
                            <option value="–£—á–µ–±–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞">–£—á–µ–±–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</option>
                            <option value="–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞">–¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</option>
                            <option value="–î–µ—Ç—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞">–î–µ—Ç—Å–∫–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</option>
                            <option value="–°–ø—Ä–∞–≤–æ—á–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞">–°–ø—Ä–∞–≤–æ—á–Ω–∞—è –ª–∏—Ç–µ—Ä–∞—Ç—É—Ä–∞</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                        <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫—É–ø–∫–∞–º–∏ -->
<div class="modal fade" id="purchasesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫—É–ø–∫–∞–º–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addPurchaseForm" class="mb-4">
                    <div class="row">
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤</label>
                                <input type="number" class="form-control" name="quantity" required min="1">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">–°—Ç–æ–∏–º–æ—Å—Ç—å –∑–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä</label>
                                <input type="number" class="form-control" name="price" required min="0">
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="mb-3">
                                <label class="form-label">–ü–æ—Å—Ç–∞–≤—â–∏–∫</label>
                                <input type="text" class="form-control" name="supplier" required>
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫—É–ø–∫—É</button>
                </form>

                <h6>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫—É–ø–æ–∫</h6>
                <div class="table-responsive">
                    <table class="table table-sm" id="purchasesHistory">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                <th>–¶–µ–Ω–∞/—à—Ç</th>
                                <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫—É–ø–æ–∫ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const searchQuery = this.value.trim();
            window.location.href = `?page=1&search=${encodeURIComponent(searchQuery)}`;
        }, 500);
    });
});

function editBook(id, title, author, description, theme) {
    const modal = new bootstrap.Modal(document.getElementById('bookModal'));
    document.getElementById('modalTitle').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É';
    document.getElementById('bookId').value = id;
    document.getElementById('title').value = title;
    document.getElementById('author').value = author;
    document.getElementById('description').value = description || '';
    document.getElementById('theme').value = theme || '';
    modal.show();
}

function deleteBook(id) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–Ω–∏–≥—É?')) {
        fetch(`/books/${id}/delete`, {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                location.reload();
            }
        });
    }
}

function managePurchases(bookId) {
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('addPurchaseForm').reset();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫—É–ø–æ–∫
    fetch(`/books/${bookId}/purchases`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#purchasesHistory tbody');
            tbody.innerHTML = '';
            
            data.purchases.forEach(p => {
                tbody.innerHTML += `
                    <tr>
                        <td>${p.date}</td>
                        <td>${p.quantity}</td>
                        <td>${p.price} ‚ÇΩ</td>
                        <td>${p.supplier}</td>
                    </tr>
                `;
            });
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫—É–ø–∫–∏
            const form = document.getElementById('addPurchaseForm');
            form.onsubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                
                fetch(`/books/${bookId}/purchases/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        quantity: parseInt(formData.get('quantity')),
                        price: parseInt(formData.get('price')),
                        supplier: formData.get('supplier')
                    })
                }).then(response => {
                    if (response.ok) {
                        location.reload();
                    }
                });
            };
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            new bootstrap.Modal(document.getElementById('purchasesModal')).show();
        });
}

// –î–æ–±–∞–≤–∏–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–Ω–∏–≥–∞–º–∏
document.getElementById('bookForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = {
        title: document.getElementById('title').value,
        author: document.getElementById('author').value,
        description: document.getElementById('description').value,
        theme: document.getElementById('theme').value
    };
    
    const bookId = document.getElementById('bookId').value;
    const url = bookId ? `/api/books/${bookId}` : '/api/books';
    const method = bookId ? 'PUT' : 'POST';
    
    try {
        const response = await fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(formData)
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            const data = await response.json();
            alert(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–Ω–∏–≥–∏');
        }
    } catch (error) {
        console.error('Error:', error);
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∫–Ω–∏–≥–∏');
    }
});
</script>
{% endblock %} 