{% extends "base.html" %}

{% block title %}–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∫–Ω–∏–≥–∞–º–∏ - Library Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- –°–≤–æ–¥–∫–∞ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-primary mb-3">
                        <span class="fs-2">üìö</span><br>
                        –í—Å–µ–≥–æ –∫–Ω–∏–≥
                    </h5>
                    <p class="card-text display-6 mb-0">{{ total_books }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-success mb-3">
                        <span class="fs-2">üìñ</span><br>
                        –í—Å–µ–≥–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤
                    </h5>
                    <p class="card-text display-6 mb-0">{{ total_copies }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-warning mb-3">
                        <span class="fs-2">üìò</span><br>
                        –í—ã–¥–∞–Ω–æ
                    </h5>
                    <p class="card-text display-6 mb-0">{{ borrowed_copies }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card shadow-sm">
                <div class="card-body text-center">
                    <h5 class="card-title text-danger mb-3">
                        <span class="fs-2">‚è±Ô∏è</span><br>
                        –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ
                    </h5>
                    <a href="/overdue-books" class="text-decoration-none">
                        <p class="card-text display-6 mb-0">{{ overdue_copies|default(0) }}</p>
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- –ü–æ–∏—Å–∫ -->
    <div class="card mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-md-8">
                    <div class="input-group">
                        <span class="input-group-text bg-primary text-white">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text" 
                               class="form-control border-primary" 
                               id="searchInput" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é –∏–ª–∏ –∞–≤—Ç–æ—Ä—É..."
                               value="{{ search_query }}">
                    </div>
                </div>
                <div class="col-md-4 text-end">
                    <div class="btn-group">
                        <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#bookModal">
                            ‚ûï –î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É
                        </button>
                        <button type="button" class="btn btn-primary dropdown-toggle dropdown-toggle-split" data-bs-toggle="dropdown">
                            <span class="visually-hidden">Toggle Dropdown</span>
                        </button>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/admin/books/template/download">üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω Excel</a></li>
                            <li><a class="dropdown-item" href="/admin/books/template/isbn/download">üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω Excel (–ø–æ ISBN)</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="#" onclick="document.getElementById('excelUploadFull').click()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ –∫–Ω–∏–≥–∏</a></li>
                            <li><a class="dropdown-item" href="#" onclick="document.getElementById('excelUploadIsbn').click()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –Ω–æ–≤—ã–µ –∫–Ω–∏–≥–∏ (–ø–æ ISBN)</a></li>
                        </ul>
                    </div>
                    <input type="file" id="excelUploadFull" style="display: none" accept=".xlsx" onchange="uploadExcel(this, 'full')">
                    <input type="file" id="excelUploadIsbn" style="display: none" accept=".xlsx" onchange="uploadExcel(this, 'isbn')">
                </div>
            </div>
        </div>
    </div>

    <!-- –¢–∞–±–ª–∏—Ü–∞ –∫–Ω–∏–≥ -->
    <div class="table-responsive">
        <table class="table table-striped table-books">
            <thead>
                <tr>
                    <th class="col-id">
                        <a href="#" class="sort-link" data-sort="id">
                            ID <span class="sort-indicator {% if sort == 'id' %}active{% endif %}">{% if sort == "id" and order == "desc" %}‚ñº{% else %}‚ñ≤{% endif %}</span>
                        </a>
                    </th>
                    <th class="col-title">
                        <a href="#" class="sort-link" data-sort="title">
                            –ù–∞–∑–≤–∞–Ω–∏–µ <span class="sort-indicator {% if sort == 'title' %}active{% endif %}">{% if sort == "title" and order == "desc" %}‚ñº{% else %}‚ñ≤{% endif %}</span>
                        </a>
                    </th>
                    <th class="col-author">
                        <a href="#" class="sort-link" data-sort="author">
                            –ê–≤—Ç–æ—Ä <span class="sort-indicator {% if sort == 'author' %}active{% endif %}">{% if sort == "author" and order == "desc" %}‚ñº{% else %}‚ñ≤{% endif %}</span>
                        </a>
                    </th>
                    <th class="col-theme">
                        <a href="#" class="sort-link" data-sort="theme">
                            –¢–µ–º–∞—Ç–∏–∫–∞ <span class="sort-indicator {% if sort == 'theme' %}active{% endif %}">{% if sort == "theme" and order == "desc" %}‚ñº{% else %}‚ñ≤{% endif %}</span>
                        </a>
                    </th>
                    <th class="col-description">–û–ø–∏—Å–∞–Ω–∏–µ</th>
                    <th class="col-pages">
                        <a href="#" class="sort-link" data-sort="pages">
                            –°—Ç—Ä. <span class="sort-indicator {% if sort == 'pages' %}active{% endif %}">{% if sort == "pages" and order == "desc" %}‚ñº{% else %}‚ñ≤{% endif %}</span>
                        </a>
                    </th>
                    <th class="col-edition">
                        <a href="#" class="sort-link" data-sort="edition_number">
                            ‚Ññ <span class="sort-indicator {% if sort == 'edition_number' %}active{% endif %}">{% if sort == "edition_number" and order == "desc" %}‚ñº{% else %}‚ñ≤{% endif %}</span>
                        </a>
                    </th>
                    <th class="col-year">
                        <a href="#" class="sort-link" data-sort="publication_year">
                            –ì–æ–¥ <span class="sort-indicator {% if sort == 'publication_year' %}active{% endif %}">{% if sort == "publication_year" and order == "desc" %}‚ñº{% else %}‚ñ≤{% endif %}</span>
                        </a>
                    </th>
                    <th class="col-publisher">
                        <a href="#" class="sort-link" data-sort="publisher">
                            –ò–∑–¥–∞—Ç. <span class="sort-indicator {% if sort == 'publisher' %}active{% endif %}">{% if sort == "publisher" and order == "desc" %}‚ñº{% else %}‚ñ≤{% endif %}</span>
                        </a>
                    </th>
                    <th class="col-textbook">–£—á.</th>
                    <th class="col-copies">
                        <a href="#" class="sort-link" data-sort="available_copies">
                            –î–æ—Å—Ç—É–ø–Ω–æ <span class="sort-indicator {% if sort == 'available_copies' %}active{% endif %}">{% if sort == "available_copies" and order == "desc" %}‚ñº{% else %}‚ñ≤{% endif %}</span>
                        </a>
                    </th>
                    <th class="col-price">–¶–µ–Ω–∞</th>
                    <th class="col-actions">–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for book in books %}
                <tr>
                    <td>{{ book.id }}</td>
                    <td>{{ book.title }}</td>
                    <td>{{ book.author }}</td>
                    <td>{{ book.theme or '‚Äî' }}</td>
                    <td class="description-cell">{{ book.description }}</td>
                    <td>{{ book.pages }}</td>
                    <td>{{ book.edition_number or '‚Äî' }}</td>
                    <td>{{ book.publication_year }}</td>
                    <td>{{ book.publisher }}</td>
                    <td>{% if book.is_textbook == 'Y' %}–î–∞{% else %}–ù–µ—Ç{% endif %}</td>
                    <td>{{ book.available_copies }}/{{ book.total_copies }}</td>
                    <td>
                        {% if book.avg_price and book.avg_price > 0 %}
                            {{ "%.2f"|format(book.avg_price) }}
                        {% else %}
                            ‚Äî
                        {% endif %}
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-sm btn-primary edit-book-btn" 
                                    data-id="{{ book.id }}"
                                    data-bs-toggle="tooltip" 
                                    title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                                ‚úèÔ∏è
                            </button>
                            <button class="btn btn-sm btn-danger" 
                                    onclick="deleteBook({{ book.id }})" 
                                    data-bs-toggle="tooltip" 
                                    title="–£–¥–∞–ª–∏—Ç—å">
                                üóëÔ∏è
                            </button>
                            <button class="btn btn-sm btn-warning" 
                                    onclick="managePurchases({{ book.id }})" 
                                    data-bs-toggle="tooltip" 
                                    title="–ó–∞–∫—É–ø–∫–∏">
                                üì¶
                            </button>
                            <a href="/books/{{ book.id }}/qrcodes" 
                               class="btn btn-sm btn-info" 
                               data-bs-toggle="tooltip" 
                               title="QR">
                                üîç
                            </a>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="?page=1&search={{ search_query }}&sort={{ sort }}&order={{ order }}" aria-label="First">
                    <span aria-hidden="true">¬´¬´</span>
                </a>
            </li>
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="?page={{ current_page - 1 }}&search={{ search_query }}&sort={{ sort }}&order={{ order }}" aria-label="Previous">
                    <span aria-hidden="true">¬´</span>
                </a>
            </li>
            
            {% for page in range(max(1, current_page - 2), min(total_pages + 1, current_page + 3)) %}
            <li class="page-item {% if page == current_page %}active{% endif %}">
                <a class="page-link" href="?page={{ page }}&search={{ search_query }}&sort={{ sort }}&order={{ order }}">{{ page }}</a>
            </li>
            {% endfor %}
            
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="?page={{ current_page + 1 }}&search={{ search_query }}&sort={{ sort }}&order={{ order }}" aria-label="Next">
                    <span aria-hidden="true">¬ª</span>
                </a>
            </li>
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="?page={{ total_pages }}&search={{ search_query }}&sort={{ sort }}&order={{ order }}" aria-label="Last">
                    <span aria-hidden="true">¬ª¬ª</span>
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–∏–≥–∏ -->
<div class="modal fade" id="bookModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="bookModalLabel">–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="bookForm">
                <div class="modal-body">
                    <input type="hidden" id="bookId">
                    
                    <div class="row mb-3">
                        <div class="col-md-8">
                            <label for="bookIsbn" class="form-label">ISBN</label>
                            <input type="text" class="form-control" id="bookIsbn" name="isbn" placeholder="–Ω–∞–ø—Ä–∏–º–µ—Ä: 9785170870639">
                        </div>
                        <div class="col-md-4 d-flex align-items-end">
                            <button type="button" class="btn btn-outline-primary w-100" id="findByIsbnBtn">
                                <i class="fas fa-search"></i> –ù–∞–π—Ç–∏ –ø–æ ISBN
                            </button>
                        </div>
                    </div>
                    
                    <div class="mb-3">
                        <label for="bookTitle" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏*</label>
                        <input type="text" class="form-control" id="bookTitle" name="title" required>
                    </div>
                    <div class="mb-3">
                        <label for="bookAuthor" class="form-label">–ê–≤—Ç–æ—Ä*</label>
                        <input type="text" class="form-control" id="bookAuthor" name="author" required>
                    </div>
                    <div class="mb-3">
                        <label for="bookTheme" class="form-label">–¢–µ–º–∞—Ç–∏–∫–∞(–ñ–∞–Ω—Ä)*</label>
                        <input type="text" class="form-control" id="bookTheme" name="theme" required>
                    </div>
                    <div class="mb-3">
                        <label for="bookDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ*</label>
                        <textarea class="form-control" id="bookDescription" name="description" required></textarea>
                    </div>
                    <div class="mb-3">
                        <label for="bookPages" class="form-label">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–∞–Ω–∏—Ü*</label>
                        <input type="number" class="form-control" id="bookPages" name="pages" required min="1">
                    </div>
                    <div class="mb-3">
                        <label for="bookEditionNumber" class="form-label">–ù–æ–º–µ—Ä –∏–∑–¥–∞–Ω–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å)</label>
                        <input type="text" class="form-control" id="bookEditionNumber" name="edition_number">
                    </div>
                    <div class="mb-3">
                        <label for="bookPublicationYear" class="form-label">–ì–æ–¥ –∏–∑–¥–∞–Ω–∏—è*</label>
                        <input type="number" class="form-control" id="bookPublicationYear" name="publication_year" required>
                    </div>
                    <div class="mb-3">
                        <label for="bookPublisher" class="form-label">–ò–∑–¥–∞—Ç–µ–ª—å—Å—Ç–≤–æ*</label>
                        <input type="text" class="form-control" id="bookPublisher" name="publisher" required>
                    </div>
                    <div class="mb-3 form-check">
                        <input type="checkbox" class="form-check-input" id="bookIsTextbook" name="is_textbook" value="Y">
                        <label class="form-check-label" for="bookIsTextbook">–≠—Ç–æ —É—á–µ–±–Ω–∏–∫</label>
                    </div>
                    <!-- –î–æ–±–∞–≤–ª—è–µ–º —Å–∫—Ä—ã—Ç–æ–µ –ø–æ–ª–µ quantity —Å –∑–Ω–∞—á–µ–Ω–∏–µ–º –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0 -->
                    <input type="hidden" id="bookQuantity" name="quantity" value="0">
                    <div class="alert alert-info">
                        <i class="fas fa-info-circle"></i> –≠–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–Ω–∏–≥ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è —Ç–æ–ª—å–∫–æ —á–µ—Ä–µ–∑ —É—á–µ—Ç –∑–∞–∫—É–ø–æ–∫. –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–Ω–∏–≥–∏, –≤—ã —Å–º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–∫—É–ø–∫—É —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫—É–ø–∫–∞–º–∏".
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫—É–ø–∫–∞–º–∏ -->
<div class="modal fade" id="purchasesModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫—É–ø–∫–∞–º–∏</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="alert alert-info">
                    <i class="fas fa-info-circle"></i> –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫—É–ø–∫–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤ –∫–Ω–∏–≥–∏.
                </div>
                
                <form id="addPurchaseForm" class="mb-4">
                    <div class="row">
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">–ö–æ–ª-–≤–æ —ç–∫–∑–µ–º–ø–ª—è—Ä–æ–≤*</label>
                                <input type="number" class="form-control" id="quantity" name="quantity" required min="1">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">–¶–µ–Ω–∞ –∑–∞ —ç–∫–∑–µ–º–ø–ª—è—Ä (‚ÇΩ)</label>
                                <input type="number" class="form-control" name="price" required min="0">
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">–ü–æ—Å—Ç–∞–≤—â–∏–∫*</label>
                                <input type="text" class="form-control" name="supplier" required>
                            </div>
                        </div>
                        <div class="col-md-3">
                            <div class="mb-3">
                                <label class="form-label">–î–∞—Ç–∞ –ø–æ—Å—Ç–∞–≤–∫–∏</label>
                                <input type="date" class="form-control" name="purchase_date">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–∫—É–ø–∫—É</button>
                </form>

                <h6>–ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫—É–ø–æ–∫</h6>
                <div class="table-responsive">
                    <table class="table table-sm" id="purchasesHistory">
                        <thead>
                            <tr>
                                <th>–î–∞—Ç–∞</th>
                                <th>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ</th>
                                <th>–¶–µ–Ω–∞/—à—Ç</th>
                                <th>–û–±—â–∞—è —Å—É–º–º–∞</th>
                                <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                            </tr>
                        </thead>
                        <tbody>
                            <!-- –ò—Å—Ç–æ—Ä–∏—è –∑–∞–∫—É–ø–æ–∫ –±—É–¥–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–∞ —á–µ—Ä–µ–∑ JavaScript -->
                        </tbody>
                        <tfoot>
                            <tr class="fw-bold">
                                <td>–ò—Ç–æ–≥–æ:</td>
                                <td id="totalQuantity">0</td>
                                <td>-</td>
                                <td id="totalPrice">0 ‚ÇΩ</td>
                                <td>-</td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
</div>

<style>
/* –°—Ç–∏–ª—å –¥–ª—è —Å—Å—ã–ª–æ–∫ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
.sort-link {
    color: inherit; /* –ù–∞—Å–ª–µ–¥—É–µ–º —Ü–≤–µ—Ç –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
    text-decoration: none; /* –£–±–∏—Ä–∞–µ–º –ø–æ–¥—á–µ—Ä–∫–∏–≤–∞–Ω–∏–µ */
    cursor: pointer; /* –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∫—É—Ä—Å–æ—Ä –∫–∞–∫ –¥–ª—è —Å—Å—ã–ª–∫–∏ */
    font-weight: inherit; /* –ù–∞—Å–ª–µ–¥—É–µ–º –∂–∏—Ä–Ω–æ—Å—Ç—å –æ—Ç —Ä–æ–¥–∏—Ç–µ–ª—å—Å–∫–æ–≥–æ —ç–ª–µ–º–µ–Ω—Ç–∞ */
    display: inline-flex; /* –ò—Å–ø–æ–ª—å–∑—É–µ–º inline-flex –¥–ª—è –∫–æ–º–ø–∞–∫—Ç–Ω–æ—Å—Ç–∏ */
    align-items: center; /* –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –ø–æ –≤–µ—Ä—Ç–∏–∫–∞–ª–∏ */
    white-space: nowrap; /* –ó–∞–ø—Ä–µ—â–∞–µ–º –ø–µ—Ä–µ–Ω–æ—Å —Ç–µ–∫—Å—Ç–∞ */
}

.sort-link:hover {
    color: #0d6efd; /* –ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º, —á—Ç–æ —ç—Ç–æ –∫–ª–∏–∫–∞–±–µ–ª—å–Ω–æ */
    text-decoration: none;
}

/* –°—Ç–∏–ª—å –¥–ª—è –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
.sort-indicator {
    font-size: 0.75em; /* –î–µ–ª–∞–µ–º —Å—Ç—Ä–µ–ª–∫–∏ –Ω–µ–º–Ω–æ–≥–æ –º–µ–Ω—å—à–µ */
    margin-left: 3px; /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø —Å–ª–µ–≤–∞ */
    opacity: 0.3; /* –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é —Å—Ç—Ä–µ–ª–∫–∏ –Ω–µ–º–Ω–æ–≥–æ –ø—Ä–æ–∑—Ä–∞—á–Ω—ã–µ */
    display: inline-block; /* –î–µ–ª–∞–µ–º —Å—Ç—Ä–æ—á–Ω–æ-–±–ª–æ—á–Ω—ã–º —ç–ª–µ–º–µ–Ω—Ç–æ–º */
}

/* –ê–∫—Ç–∏–≤–Ω—ã–π –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ */
.sort-indicator.active {
    opacity: 1; /* –ê–∫—Ç–∏–≤–Ω–∞—è —Å—Ç—Ä–µ–ª–∫–∞ –Ω–µ–ø—Ä–æ–∑—Ä–∞—á–Ω–∞—è */
    color: #0d6efd; /* –¶–≤–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ–π —Å—Ç—Ä–µ–ª–∫–∏ */
}

/* –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏—è —Ç–∞–±–ª–∏—Ü—ã */
.table-books {
    font-size: 0.85rem; /* –£–º–µ–Ω—å—à–∞–µ–º —Ä–∞–∑–º–µ—Ä —à—Ä–∏—Ñ—Ç–∞ */
    width: 100%;
    table-layout: fixed; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –º–∞–∫–µ—Ç —Ç–∞–±–ª–∏—Ü—ã */
    margin-bottom: 0; /* –£–±–∏—Ä–∞–µ–º –Ω–∏–∂–Ω–∏–π –æ—Ç—Å—Ç—É–ø */
}

.table-books th, .table-books td {
    padding: 0.3rem 0.5rem; /* –£–º–µ–Ω—å—à–∞–µ–º –æ—Ç—Å—Ç—É–ø—ã –≤ —è—á–µ–π–∫–∞—Ö */
    vertical-align: middle;
    word-wrap: break-word; /* –ü–µ—Ä–µ–Ω–æ—Å –¥–ª–∏–Ω–Ω—ã—Ö —Å–ª–æ–≤ */
    max-width: 150px; /* –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è —à–∏—Ä–∏–Ω–∞ —è—á–µ–π–∫–∏ */
}

/* –®–∏—Ä–∏–Ω–∞ –¥–ª—è —Ä–∞–∑–Ω—ã—Ö —Å—Ç–æ–ª–±—Ü–æ–≤ */
.table-books .col-id {
    width: 3%;
}
.table-books .col-title {
    width: 12%;
}
.table-books .col-author {
    width: 8%;
}
.table-books .col-theme {
    width: 7%;
}
.table-books .col-description {
    width: 12%;
}
.table-books .col-pages {
    width: 4%;
}
.table-books .col-edition {
    width: 3%;
}
.table-books .col-year {
    width: 4%;
}
.table-books .col-publisher {
    width: 6%;
}
.table-books .col-textbook {
    width: 3%;
}
.table-books .col-copies {
    width: 5%;
}
.table-books .col-price {
    width: 4%;
}
.table-books .col-actions {
    width: 10%;
    white-space: nowrap;
}

/* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –≤—ã—Å–æ—Ç—ã –¥–ª—è –¥–ª–∏–Ω–Ω—ã—Ö –æ–ø–∏—Å–∞–Ω–∏–π */
.description-cell {
    max-height: 70px;
    overflow-y: auto;
}

/* –ö–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ –¥–µ–π—Å—Ç–≤–∏–π */
.table-books .btn-group-sm .btn {
    padding: 0.1rem 0.3rem; /* –û—á–µ–Ω—å –∫–æ–º–ø–∞–∫—Ç–Ω—ã–µ –∫–Ω–æ–ø–∫–∏ */
    font-size: 0.8rem;
}
</style>

<script>
// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });

    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –ø–æ–∏—Å–∫–∞
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;
    
    searchInput.addEventListener('input', function() {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            const searchQuery = this.value.trim();
            const urlParams = new URLSearchParams(window.location.search);
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            const sort = urlParams.get('sort') || 'title';
            const order = urlParams.get('order') || 'asc';
            
            // –û–±–Ω–æ–≤–ª—è–µ–º URL —Å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            window.location.href = `?page=1&search=${encodeURIComponent(searchQuery)}&sort=${sort}&order=${order}`;
        }, 500);
    });

    // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–æ–∫ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–Ω–∏–≥–∏
    const editButtons = document.querySelectorAll('.edit-book-btn');
    editButtons.forEach(button => {
        button.addEventListener('click', function() {
            const bookId = this.getAttribute('data-id');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ –ø–æ AJAX
            fetch(`/books/${bookId}/json`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥–∏');
                    }
                    return response.json();
                })
                .then(book => {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∫–Ω–∏–≥–∏
                    document.getElementById('bookId').value = book.id;
                    document.getElementById('bookTitle').value = book.title;
                    document.getElementById('bookAuthor').value = book.author;
                    document.getElementById('bookTheme').value = book.theme || '';
                    document.getElementById('bookDescription').value = book.description;
                    document.getElementById('bookPages').value = book.pages || '';
                    document.getElementById('bookEditionNumber').value = book.edition_number || '';
                    document.getElementById('bookPublicationYear').value = book.publication_year || '';
                    document.getElementById('bookPublisher').value = book.publisher || '';
                    document.getElementById('bookIsTextbook').checked = (book.is_textbook === 'Y');
                    
                    // –ú–µ–Ω—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
                    document.getElementById('bookModalLabel').textContent = '–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –∫–Ω–∏–≥—É';
                    
                    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
                    const modal = new bootstrap.Modal(document.getElementById('bookModal'));
                    modal.show();
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞:', error);
                    showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –∫–Ω–∏–≥–∏', 'error');
                });
        });
    });
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ –¥–ª—è –∫–Ω–æ–ø–∫–∏ "–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É"
    const addBookBtn = document.querySelector('[data-bs-toggle="modal"][data-bs-target="#bookModal"]');
    if (addBookBtn) {
        addBookBtn.addEventListener('click', function() {
            // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É –ø–µ—Ä–µ–¥ –æ—Ç–∫—Ä—ã—Ç–∏–µ–º –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
            document.getElementById('bookForm').reset();
            document.getElementById('bookId').value = '';
            document.getElementById('bookModalLabel').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É';
        });
    }
});

function deleteBook(id) {
    if (confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∫–Ω–∏–≥—É?')) {
        fetch(`/books/${id}/delete`, {
            method: 'POST'
        }).then(response => {
            if (response.ok) {
                showToast('–ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ —É–¥–∞–ª–µ–Ω–∞', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ –∫–Ω–∏–≥–∏', 'error');
            }
        });
    }
}

function managePurchases(bookId) {
    // –û—á–∏—â–∞–µ–º —Ñ–æ—Ä–º—É
    document.getElementById('addPurchaseForm').reset();
    
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é –∑–∞–∫—É–ø–æ–∫
    fetch(`/books/${bookId}/purchases`)
        .then(response => response.json())
        .then(data => {
            const tbody = document.querySelector('#purchasesHistory tbody');
            tbody.innerHTML = '';
            
            let totalQuantity = 0;
            let totalPrice = 0;
            
            if (data.purchases && data.purchases.length > 0) {
                data.purchases.forEach(p => {
                    const quantity = parseInt(p.quantity) || 0;
                    const price = parseFloat(p.price) || 0;
                    const totalItemPrice = quantity * price;
                    
                    totalQuantity += quantity;
                    totalPrice += totalItemPrice;
                    
                    tbody.innerHTML += `
                        <tr>
                            <td>${p.date}</td>
                            <td>${quantity}</td>
                            <td>${price.toFixed(2)} ‚ÇΩ</td>
                            <td>${totalItemPrice.toFixed(2)} ‚ÇΩ</td>
                            <td>${p.supplier}</td>
                        </tr>
                    `;
                });
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Ç–æ–≥–∏
                document.getElementById('totalQuantity').textContent = totalQuantity;
                document.getElementById('totalPrice').textContent = totalPrice.toFixed(2) + ' ‚ÇΩ';
            } else {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="text-center">
                            <div class="alert alert-warning mb-0">
                                –î–ª—è —ç—Ç–æ–π –∫–Ω–∏–≥–∏ –µ—â—ë –Ω–µ –±—ã–ª–æ –∑–∞–∫—É–ø–æ–∫. –î–æ–±–∞–≤—å—Ç–µ –ø–µ—Ä–≤—É—é –∑–∞–∫—É–ø–∫—É, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä—ã –∫–Ω–∏–≥–∏.
                            </div>
                        </td>
                    </tr>
                `;
                
                // –û–±–Ω—É–ª—è–µ–º –∏—Ç–æ–≥–∏
                document.getElementById('totalQuantity').textContent = '0';
                document.getElementById('totalPrice').textContent = '0 ‚ÇΩ';
            }
            
            // –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—É—â—É—é –¥–∞—Ç—É –≤ –ø–æ–ª–µ –¥–∞—Ç—ã –ø–æ—Å—Ç–∞–≤–∫–∏
            const today = new Date();
            const yyyy = today.getFullYear();
            const mm = String(today.getMonth() + 1).padStart(2, '0');
            const dd = String(today.getDate()).padStart(2, '0');
            document.querySelector('input[name="purchase_date"]').value = `${yyyy}-${mm}-${dd}`;
            
            // –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º —Ñ–æ—Ä–º—É –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–∫—É–ø–∫–∏
            const form = document.getElementById('addPurchaseForm');
            form.onsubmit = (e) => {
                e.preventDefault();
                const formData = new FormData(form);
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞—Ç—É –≤ –Ω—É–∂–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç
                let purchaseDate = formData.get('purchase_date');
                if (purchaseDate) {
                    const dateParts = purchaseDate.split('-');
                    if (dateParts.length === 3) {
                        purchaseDate = `${dateParts[2]}.${dateParts[1]}.${dateParts[0]}`;
                    }
                }
                
                fetch(`/books/${bookId}/purchases/add`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        quantity: parseInt(formData.get('quantity')),
                        price: parseFloat(formData.get('price')),
                        supplier: formData.get('supplier'),
                        purchase_date: purchaseDate
                    })
                }).then(response => {
                    if (response.ok) {
                        showToast('–ó–∞–∫—É–ø–∫–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞', 'success');
                        const modal = bootstrap.Modal.getInstance(document.getElementById('purchasesModal'));
                        if (modal) {
                            modal.hide();
                        }
                        setTimeout(() => location.reload(), 1000);
                    } else {
                        return response.json().then(errorData => {
                            showToast(`–û—à–∏–±–∫–∞: ${errorData.detail || '–ù–µ —É–¥–∞–ª–æ—Å—å –¥–æ–±–∞–≤–∏—Ç—å –∑–∞–∫—É–ø–∫—É'}`, 'error');
                        });
                    }
                }).catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –∑–∞–∫—É–ø–∫–∏:', error);
                    showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞', 'error');
                });
            };
            
            // –î–æ–±–∞–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–µ–π
            document.querySelector('.modal-title').textContent = `–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –∑–∞–∫—É–ø–∫–∞–º–∏ –¥–ª—è –∫–Ω–∏–≥–∏ #${bookId}`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
            new bootstrap.Modal(document.getElementById('purchasesModal')).show();
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫—É–ø–∫–∞—Ö:', error);
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –¥–∞–Ω–Ω—ã—Ö –æ –∑–∞–∫—É–ø–∫–∞—Ö', 'error');
        });
}

// –î–æ–±–∞–≤–∏–º —Å–∫—Ä–∏–ø—Ç –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –∫–Ω–∏–≥–∞–º–∏
document.getElementById('bookForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    if (!formData.has('is_textbook')) {
        formData.append('is_textbook', 'N');
    }
    
    const bookId = document.getElementById('bookId').value;
    const url = bookId ? `/books/${bookId}/edit` : '/books/add';
    
    // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã
    const submitButton = e.target.querySelector('button[type="submit"]');
    submitButton.disabled = true;
    submitButton.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...';
    
    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–æ—Ä–º—É —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–º —Å–ø–æ—Å–æ–±–æ–º
    fetch(url, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        // –ó–∞–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –≤ –ª—é–±–æ–º —Å–ª—É—á–∞–µ
        const modal = bootstrap.Modal.getInstance(document.getElementById('bookModal'));
        if (modal) {
            modal.hide();
        }
        
        if (response.ok || response.status === 303) {
            // –£—Å–ø–µ—à–Ω–æ–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ/–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
            const message = bookId 
                ? '–ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∞' 
                : '–ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–∞. –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –¥–æ–±–∞–≤–∏—Ç—å —ç–∫–∑–µ–º–ø–ª—è—Ä—ã —á–µ—Ä–µ–∑ –∑–∞–∫—É–ø–∫—É.';
            
            showToast(message, 'success');
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ –∫–æ—Ä–æ—Ç–∫–æ–µ –≤—Ä–µ–º—è
            setTimeout(() => {
                window.location.reload();
            }, 1500);
        } else {
            // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
            submitButton.disabled = false;
            submitButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
            
            // –û—Ç–æ–±—Ä–∞–∂–∞–µ–º –æ—à–∏–±–∫—É
            response.json().then(data => {
                showToast(`–û—à–∏–±–∫–∞: ${data.detail || response.statusText}`, 'error');
            }).catch(() => {
                showToast(`–û—à–∏–±–∫–∞: ${response.statusText}`, 'error');
            });
        }
    })
    .catch(error => {
        // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        submitButton.disabled = false;
        submitButton.textContent = '–°–æ—Ö—Ä–∞–Ω–∏—Ç—å';
        
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–æ—Ä–º—ã:', error);
        showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞', 'error');
    });
});

function uploadExcel(input, mode) {
    if (!input.files || !input.files[0]) return;
    
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
    showToast('–ó–∞–≥—Ä—É–∑–∫–∞ —Ñ–∞–π–ª–∞...', 'info');
    
    const formData = new FormData();
    formData.append('file', input.files[0]);
    formData.append('mode', mode); // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä —Ä–µ–∂–∏–º–∞
    
    // –û—Ç–∫–ª—é—á–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –Ω–æ–≤–æ–π –∑–∞–≥—Ä—É–∑–∫–∏ –≤–æ –≤—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
    input.disabled = true;
    
    fetch('/admin/books/upload', {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            return response.json().then(data => {
                // –£–¥–∞–ª—è–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
                const toasts = document.querySelectorAll('.toast');
                toasts.forEach(toast => toast.remove());
                
                // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –µ—Å—Ç—å –ª–∏ –≤ —Å–æ–æ–±—â–µ–Ω–∏–∏ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
                if (data.message && data.message.includes("–ü–†–ï–î–£–ü–†–ï–ñ–î–ï–ù–ò–Ø")) {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ—à–∏–±–∫–∞–º–∏
                    const errorMessage = data.message.replace(/\n/g, '<br>');
                    const alertHTML = `
                        <div class="alert alert-warning alert-dismissible fade show" role="alert">
                            <h5>–ó–∞–≥—Ä—É–∑–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∞ —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏</h5>
                            <div style="max-height: 300px; overflow-y: auto;">${errorMessage}</div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                        </div>
                    `;
                    document.querySelector('.container').insertAdjacentHTML('afterbegin', alertHTML);
                    
                    // –î–æ–±–∞–≤–ª—è–µ–º –∫–Ω–æ–ø–∫—É –¥–ª—è –Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ–≥–æ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã
                    const reloadButton = document.createElement('button');
                    reloadButton.textContent = '–û–±–Ω–æ–≤–∏—Ç—å —Å–µ–π—á–∞—Å';
                    reloadButton.className = 'btn btn-sm btn-primary mt-2';
                    reloadButton.addEventListener('click', () => location.reload());
                    document.querySelector('.alert').appendChild(reloadButton);
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
                    showToast('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω —Å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è–º–∏. –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥.', 'warning');
                } else {
                    let successMsg = '–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω!';
                    
                    showToast(`${successMsg} –°—Ç—Ä–∞–Ω–∏—Ü–∞ –æ–±–Ω–æ–≤–∏—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏.`, 'success');
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É —á–µ—Ä–µ–∑ 5 —Å–µ–∫—É–Ω–¥
                setTimeout(() => location.reload(), 5000);
            }).catch(error => {
                console.error('Error parsing JSON:', error);
                showToast('–§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω, –Ω–æ –≤–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞', 'warning');
                setTimeout(() => location.reload(), 3000);
            });
        } else {
            return response.json().then(error => {
                showToast(`–û—à–∏–±–∫–∞: ${error.error || '–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞'}`, 'error');
            }).catch(() => {
                // –ï—Å–ª–∏ –æ—Ç–≤–µ—Ç –Ω–µ –≤ —Ñ–æ—Ä–º–∞—Ç–µ JSON
                showToast(`–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${response.status} ${response.statusText}`, 'error');
            });
        }
    }).catch(error => {
        console.error('Error:', error);
        showToast('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞', 'error');
    }).finally(() => {
        // –í–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –∑–∞–≥—Ä—É–∑–∫–∏
        input.disabled = false;
        // –°–±—Ä–∞—Å—ã–≤–∞–µ–º –∑–Ω–∞—á–µ–Ω–∏–µ –ø–æ–ª—è –≤–≤–æ–¥–∞, —á—Ç–æ–±—ã –º–æ–∂–Ω–æ –±—ã–ª–æ –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ—Ç –∂–µ —Ñ–∞–π–ª –ø–æ–≤—Ç–æ—Ä–Ω–æ
        input.value = '';
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showToast(message, type = 'success') {
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-primary';
    
    const toastHTML = `
        <div id="${toastId}" class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="3000">
            <div class="toast-header ${bgClass} text-white">
                <strong class="me-auto">${type === 'success' ? '–£—Å–ø–µ—à–Ω–æ' : type === 'error' ? '–û—à–∏–±–∫–∞' : '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ'}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    document.getElementById('toast-container').insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById(toastId);
    
    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è Toast
    try {
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', e);
        // –ï—Å–ª–∏ Bootstrap Toast –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–æ–±–∞–≤–∏–º –∫–ª–∞—Å—Å show –≤—Ä—É—á–Ω—É—é
        toastElement.classList.add('show');
        
        // –ò —É–¥–∞–ª–∏–º –µ–≥–æ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            toastElement.remove();
        }, 3000);
    }
    
    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è
    toastElement.addEventListener('hidden.bs.toast', function () {
        toastElement.remove();
    });
}

// –û—á–∏—Å—Ç–∫–∞ —Ñ–æ—Ä–º—ã –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
document.getElementById('bookModal').addEventListener('hidden.bs.modal', function () {
    document.getElementById('bookForm').reset();
    document.getElementById('bookId').value = '';
    document.getElementById('bookModalLabel').textContent = '–î–æ–±–∞–≤–∏—Ç—å –∫–Ω–∏–≥—É';
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
document.addEventListener('DOMContentLoaded', function() {
    // –ü–æ–ª—É—á–∞–µ–º –≤—Å–µ —Å—Å—ã–ª–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
    const sortLinks = document.querySelectorAll('.sort-link');
    
    // –ü–æ–ª—É—á–∞–µ–º —Ç–µ–∫—É—â–∏–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–∑ URL
    const urlParams = new URLSearchParams(window.location.search);
    const currentSort = urlParams.get('sort') || 'title';
    const currentOrder = urlParams.get('order') || 'asc';
    
    // –î–æ–±–∞–≤–ª—è–µ–º –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –∫–∞–∂–¥–æ–π —Å—Å—ã–ª–∫–∏
    sortLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            
            // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∏–∑ –∞—Ç—Ä–∏–±—É—Ç–∞ data-sort
            const sortField = this.getAttribute('data-sort');
            
            // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
            let order = 'asc';
            if (sortField === currentSort) {
                // –ï—Å–ª–∏ —É–∂–µ —Å–æ—Ä—Ç–∏—Ä—É–µ–º –ø–æ —ç—Ç–æ–º—É –ø–æ–ª—é, –º–µ–Ω—è–µ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
                order = currentOrder === 'asc' ? 'desc' : 'asc';
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL
            urlParams.set('sort', sortField);
            urlParams.set('order', order);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º URL –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü—É
            window.location.href = `?${urlParams.toString()}`;
        });
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø–æ–∏—Å–∫–∞ –∫–Ω–∏–≥–∏ –ø–æ ISBN
document.addEventListener('DOMContentLoaded', function() {
    const findByIsbnBtn = document.getElementById('findByIsbnBtn');
    if (findByIsbnBtn) {
        findByIsbnBtn.addEventListener('click', async function() {
            const isbnInput = document.getElementById('bookIsbn');
            const isbn = isbnInput.value.trim().replace(/-/g, ''); // –£–¥–∞–ª—è–µ–º –¥–µ—Ñ–∏—Å—ã –∏–∑ ISBN
            
            if (!isbn) {
                showToast('–í–≤–µ–¥–∏—Ç–µ ISBN –¥–ª—è –ø–æ–∏—Å–∫–∞', 'warning');
                return;
            }
            
            // –ë–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä –∑–∞–≥—Ä—É–∑–∫–∏
            findByIsbnBtn.disabled = true;
            findByIsbnBtn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> –ü–æ–∏—Å–∫...';
            
            try {
                const response = await fetch(`/api/books/isbn/${isbn}`);
                const data = await response.json();
                
                if (response.ok && data.book) {
                    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –∏–∑ API
                    document.getElementById('bookTitle').value = data.book.title || '';
                    document.getElementById('bookAuthor').value = data.book.author || '';
                    document.getElementById('bookTheme').value = data.book.theme || '';
                    document.getElementById('bookDescription').value = data.book.description || '';
                    document.getElementById('bookPages').value = data.book.pages || '';
                    document.getElementById('bookPublicationYear').value = data.book.publication_year || '';
                    document.getElementById('bookPublisher').value = data.book.publisher || '';
                    
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É—Å–ø–µ—Ö–µ
                    const source = data.source === 'api' ? 'Google Books API' : '–±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö';
                    showToast(`–î–∞–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã –∏–∑ ${source}`, 'success');
                } else {
                    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ–± –æ—à–∏–±–∫–µ
                    showToast(data.error || '–ö–Ω–∏–≥–∞ —Å —Ç–∞–∫–∏–º ISBN –Ω–µ –Ω–∞–π–¥–µ–Ω–∞', 'error');
                }
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–Ω–∏–≥–∏ –ø–æ ISBN:', error);
                showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–∏—Å–∫–µ –∫–Ω–∏–≥–∏', 'error');
            } finally {
                // –†–∞–∑–±–ª–æ–∫–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –∏ –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Ç–µ–∫—Å—Ç
                findByIsbnBtn.disabled = false;
                findByIsbnBtn.innerHTML = '<i class="fas fa-search"></i> –ù–∞–π—Ç–∏ –ø–æ ISBN';
            }
        });
    }
});
</script>
{% endblock %} 