{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏{% endblock %}

{% block content %}
{% if debug_roles %}
<div class="alert alert-info">
    –†–æ–ª–∏ –≤ –±–∞–∑–µ: {{ debug_roles }}
</div>
{% endif %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
        </div>
        <div class="col-auto">
            <div class="btn-group me-2">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="excelDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Excel
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="excelDropdown">
                        <li><a class="dropdown-item" href="/admin/users/template/download">üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω Excel</a></li>
                        <li><a class="dropdown-item" href="#" onclick="document.getElementById('excelUpload').click()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Excel</a></li>
                    </ul>
                </div>
                <input type="file" id="excelUpload" style="display: none" accept=".xlsx" onchange="uploadExcel(this)">
            </div>
            <!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            </button> -->
        </div>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm" method="GET" class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text">üîç</span>
                        <input type="text" 
                               class="form-control" 
                               name="search" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, ID –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É..."
                               value="{{ filters.search }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="role">
                        <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                        <option value="user" {% if filters.role == 'user' %}selected{% endif %}>–£—á–µ–Ω–∏–∫–∏</option>
                        <option value="teacher" {% if filters.role == 'teacher' %}selected{% endif %}>–£—á–∏—Ç–µ–ª—è</option>
                        <option value="admin" {% if filters.role == 'admin' %}selected{% endif %}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="status">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="active" {% if filters.status == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="blocked" {% if filters.status == 'blocked' %}selected{% endif %}>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        üîç –ù–∞–π—Ç–∏
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
                    <p class="card-text display-4">{{ stats[0] }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</h5>
                    <p class="card-text display-4">{{ stats[1] }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–£—á–∏—Ç–µ–ª–µ–π</h5>
                    <p class="card-text display-4">{{ stats[2] }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–£—á–µ–Ω–∏–∫–æ–≤</h5>
                    <p class="card-text display-4">{{ stats[3] }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
                    <th>–§–ò–û</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>–†–æ–ª—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–í–∑—è—Ç–æ –∫–Ω–∏–≥</th>
                    <th>–û—Ç–∑—ã–≤–æ–≤</th>
                    <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user[0] }}</td>
                    <td>{{ user[1] }}</td>
                    <td>{{ user[2] or '-' }}</td>
                    <td>{{ user[3] or '-' }}</td>
                    <td>
                        {% if user[4] == 'admin' %}
                            <span class="badge bg-primary">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                        {% elif user[4] == 'teacher' %}
                            <span class="badge bg-info">–£—á–∏—Ç–µ–ª—å</span>
                        {% else %}
                            <span class="badge bg-secondary">–£—á–µ–Ω–∏–∫</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user[8] == 1 %}
                            <span class="badge bg-danger">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                        {% else %}
                            <span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td>{{ user[5] }}</td>
                    <td>{{ user[6] }}</td>
                    <td>{{ user[7] or '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏' }}</td>
                    <td>
                        {% if user[4] != 'admin' %}
                        <button type="button" 
                                class="btn btn-sm {% if user[8] == 1 %}btn-success{% else %}btn-danger{% endif %}"
                                data-bs-toggle="modal" 
                                data-bs-target="#blockModal{{ user[0] }}">
                            {% if user[8] == 1 %}
                                –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                            {% else %}
                                –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                            {% endif %}
                        </button>
                        
                        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
                        <div class="modal fade" id="blockModal{{ user[0] }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            {% if user[8] == 1 %}
                                                –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                            {% else %}
                                                –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                            {% endif %}
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form action="/users/{{ user[0] }}/toggle_block" method="post">
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞:</label>
                                                <textarea name="reason" class="form-control" required></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                            <button type="submit" class="btn {% if user[8] == 1 %}btn-success{% else %}btn-danger{% endif %}">
                                                {% if user[8] == 1 %}
                                                    –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                                {% else %}
                                                    –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                                {% endif %}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
    <nav aria-label="Page navigation" class="mt-4">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="?page=1&search={{ filters.search }}" aria-label="First">
                    <span aria-hidden="true">¬´¬´</span>
                </a>
            </li>
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="?page={{ current_page - 1 }}&search={{ filters.search }}" aria-label="Previous">
                    <span aria-hidden="true">¬´</span>
                </a>
            </li>
            
            {% for page in range(max(1, current_page - 2), min(total_pages + 1, current_page + 3)) %}
            <li class="page-item {% if page == current_page %}active{% endif %}">
                <a class="page-link" href="?page={{ page }}&search={{ filters.search }}">{{ page }}</a>
            </li>
            {% endfor %}
            
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="?page={{ current_page + 1 }}&search={{ filters.search }}" aria-label="Next">
                    <span aria-hidden="true">¬ª</span>
                </a>
            </li>
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="?page={{ total_pages }}&search={{ filters.search }}" aria-label="Last">
                    <span aria-hidden="true">¬ª¬ª</span>
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>

<script>
function uploadExcel(input) {
    if (!input.files || !input.files[0]) return;
    
    const formData = new FormData();
    formData.append('file', input.files[0]);
    
    fetch('/admin/users/upload', {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            showToast('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞', 'error');
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
        }
    }).catch(error => {
        console.error('Error:', error);
        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞', 'error');
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showToast(message, type = 'success') {
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-primary';
    
    const toastHTML = `
        <div id="${toastId}" class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="3000">
            <div class="toast-header ${bgClass} text-white">
                <strong class="me-auto">${type === 'success' ? '–£—Å–ø–µ—à–Ω–æ' : type === 'error' ? '–û—à–∏–±–∫–∞' : '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ'}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    document.getElementById('toast-container').insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById(toastId);
    
    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è Toast
    try {
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', e);
        // –ï—Å–ª–∏ Bootstrap Toast –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–æ–±–∞–≤–∏–º –∫–ª–∞—Å—Å show –≤—Ä—É—á–Ω—É—é
        toastElement.classList.add('show');
        
        // –ò —É–¥–∞–ª–∏–º –µ–≥–æ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            toastElement.remove();
        }, 3000);
    }
    
    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è
    toastElement.addEventListener('hidden.bs.toast', function () {
        toastElement.remove();
    });
}
</script>
{% endblock %} 