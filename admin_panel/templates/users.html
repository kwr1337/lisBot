{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏{% endblock %}

{% block content %}
{% if debug_roles %}
<div class="alert alert-info">
    –†–æ–ª–∏ –≤ –±–∞–∑–µ: {{ debug_roles }}
</div>
{% endif %}
<div class="container mt-4">
    <h2>–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º–∏</h2>
    
    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm" method="GET" class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text">üîç</span>
                        <input type="text" 
                               class="form-control" 
                               name="search" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, ID –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É..."
                               value="{{ filters.search }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="role">
                        <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                        <option value="user" {% if filters.role == 'user' %}selected{% endif %}>–£—á–µ–Ω–∏–∫–∏</option>
                        <option value="teacher" {% if filters.role == 'teacher' %}selected{% endif %}>–£—á–∏—Ç–µ–ª—è</option>
                        <option value="admin" {% if filters.role == 'admin' %}selected{% endif %}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="status">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="active" {% if filters.status == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="blocked" {% if filters.status == 'blocked' %}selected{% endif %}>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        üîç –ù–∞–π—Ç–∏
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
                    <p class="card-text display-4">{{ stats[0] }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</h5>
                    <p class="card-text display-4">{{ stats[1] }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–£—á–∏—Ç–µ–ª–µ–π</h5>
                    <p class="card-text display-4">{{ stats[2] }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–£—á–µ–Ω–∏–∫–æ–≤</h5>
                    <p class="card-text display-4">{{ stats[3] }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</th>
                    <th>–§–ò–û</th>
                    <th>–¢–µ–ª–µ—Ñ–æ–Ω</th>
                    <th>–†–æ–ª—å</th>
                    <th>–°—Ç–∞—Ç—É—Å</th>
                    <th>–í–∑—è—Ç–æ –∫–Ω–∏–≥</th>
                    <th>–û—Ç–∑—ã–≤–æ–≤</th>
                    <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user[0] }}</td>
                    <td>{{ user[1] }}</td>
                    <td>{{ user[2] or '-' }}</td>
                    <td>{{ user[3] or '-' }}</td>
                    <td>
                        {% if user[4] == 'admin' %}
                            <span class="badge bg-primary">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                        {% elif user[4] == 'teacher' %}
                            <span class="badge bg-info">–£—á–∏—Ç–µ–ª—å</span>
                        {% else %}
                            <span class="badge bg-secondary">–£—á–µ–Ω–∏–∫</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user[8] == 1 %}
                            <span class="badge bg-danger">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                        {% else %}
                            <span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td>{{ user[5] }}</td>
                    <td>{{ user[6] }}</td>
                    <td>{{ user[7] or '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏' }}</td>
                    <td>
                        {% if user[4] != 'admin' %}
                        <button type="button" 
                                class="btn btn-sm {% if user[8] == 1 %}btn-success{% else %}btn-danger{% endif %}"
                                data-bs-toggle="modal" 
                                data-bs-target="#blockModal{{ user[0] }}">
                            {% if user[8] == 1 %}
                                –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                            {% else %}
                                –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                            {% endif %}
                        </button>
                        
                        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
                        <div class="modal fade" id="blockModal{{ user[0] }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            {% if user[8] == 1 %}
                                                –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                            {% else %}
                                                –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                            {% endif %}
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form action="/users/{{ user[0] }}/toggle_block" method="post">
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞:</label>
                                                <textarea name="reason" class="form-control" required></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                            <button type="submit" class="btn {% if user[8] == 1 %}btn-success{% else %}btn-danger{% endif %}">
                                                {% if user[8] == 1 %}
                                                    –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                                {% else %}
                                                    –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                                {% endif %}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %} 