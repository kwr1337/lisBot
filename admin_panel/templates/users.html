{% extends "base.html" %}

{% block title %}–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏{% endblock %}

{% block content %}
<style>
    .sort-link {
        color: inherit !important;
        text-decoration: none !important;
        display: flex;
        align-items: center;
        justify-content: flex-start;
        cursor: pointer;
        width: 100%;
    }
    
    .sort-link:hover {
        color: #0d6efd !important;
    }
    
    .sort-indicator {
        margin-left: 5px;
        font-size: 0.8em;
        opacity: 0.3;
    }
    
    .sort-indicator.active {
        opacity: 1;
        color: #0d6efd;
    }
    
    th {
        white-space: nowrap;
    }
</style>

{% if debug_roles %}
<div class="alert alert-info">
    –†–æ–ª–∏ –≤ –±–∞–∑–µ: {{ debug_roles }}
</div>
{% endif %}
<div class="container mt-4">
    <div class="row mb-4">
        <div class="col">
            <h1>–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏</h1>
        </div>
        <div class="col-auto">
            <div class="btn-group me-2">
                <div class="dropdown">
                    <button class="btn btn-secondary dropdown-toggle" type="button" id="excelDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                        Excel
                    </button>
                    <ul class="dropdown-menu" aria-labelledby="excelDropdown">
                        <li><a class="dropdown-item" href="/admin/users/template/download">üì• –°–∫–∞—á–∞—Ç—å —à–∞–±–ª–æ–Ω Excel</a></li>
                        <li><a class="dropdown-item" href="#" onclick="document.getElementById('excelUpload').click()">üì§ –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏–∑ Excel</a></li>
                    </ul>
                </div>
                <input type="file" id="excelUpload" style="display: none" accept=".xlsx" onchange="uploadExcel(this)">
            </div>
            <!-- <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addUserModal">
                <i class="fas fa-plus"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            </button> -->
        </div>
    </div>
    
    <!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
    <div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="card mb-4">
        <div class="card-body">
            <form id="filterForm" method="GET" class="row g-3">
                <div class="col-md-4">
                    <div class="input-group">
                        <span class="input-group-text">üîç</span>
                        <input type="text" 
                               class="form-control" 
                               name="search" 
                               placeholder="–ü–æ–∏—Å–∫ –ø–æ –∏–º–µ–Ω–∏, ID –∏–ª–∏ —Ç–µ–ª–µ—Ñ–æ–Ω—É..."
                               value="{{ filters.search }}">
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="role">
                        <option value="">–í—Å–µ —Ä–æ–ª–∏</option>
                        <option value="user" {% if filters.role == 'user' %}selected{% endif %}>–£—á–µ–Ω–∏–∫–∏</option>
                        <option value="teacher" {% if filters.role == 'teacher' %}selected{% endif %}>–£—á–∏—Ç–µ–ª—è</option>
                        <option value="admin" {% if filters.role == 'admin' %}selected{% endif %}>–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—ã</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <select class="form-select" name="status">
                        <option value="">–í—Å–µ —Å—Ç–∞—Ç—É—Å—ã</option>
                        <option value="active" {% if filters.status == 'active' %}selected{% endif %}>–ê–∫—Ç–∏–≤–Ω—ã–µ</option>
                        <option value="blocked" {% if filters.status == 'blocked' %}selected{% endif %}>–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">
                        üîç –ù–∞–π—Ç–∏
                    </button>
                </div>
                <!-- –°–∫—Ä—ã—Ç—ã–µ –ø–æ–ª—è –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ -->
                <input type="hidden" name="sort" value="{{ sort }}">
                <input type="hidden" name="order" value="{{ order }}">
            </form>
        </div>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–í—Å–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</h5>
                    <p class="card-text display-4">{{ stats[0] }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–æ–≤</h5>
                    <p class="card-text display-4">{{ stats[1] }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–£—á–∏—Ç–µ–ª–µ–π</h5>
                    <p class="card-text display-4">{{ stats[2] }}</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">–£—á–µ–Ω–∏–∫–æ–≤</h5>
                    <p class="card-text display-4">{{ stats[3] }}</p>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –¢–∞–±–ª–∏—Ü–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π -->
    <div class="table-responsive">
        <table class="table table-striped">
            <thead>
                <tr>
                    <th>
                        <a href="?page={{ current_page }}&search={{ filters.search }}&role={{ filters.role }}&status={{ filters.status }}&sort=id&order={% if sort == 'id' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                            ID
                            <span class="sort-indicator {% if sort == 'id' %}active{% endif %}">
                                {% if sort == 'id' and order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            </span>
                        </a>
                    </th>
                    <th>
                        <a href="?page={{ current_page }}&search={{ filters.search }}&role={{ filters.role }}&status={{ filters.status }}&sort=username&order={% if sort == 'username' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                            –ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                            <span class="sort-indicator {% if sort == 'username' %}active{% endif %}">
                                {% if sort == 'username' and order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            </span>
                        </a>
                    </th>
                    <th>
                        <a href="?page={{ current_page }}&search={{ filters.search }}&role={{ filters.role }}&status={{ filters.status }}&sort=full_name&order={% if sort == 'full_name' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                            –§–ò–û
                            <span class="sort-indicator {% if sort == 'full_name' %}active{% endif %}">
                                {% if sort == 'full_name' and order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            </span>
                        </a>
                    </th>
                    <th>
                        <a href="?page={{ current_page }}&search={{ filters.search }}&role={{ filters.role }}&status={{ filters.status }}&sort=phone&order={% if sort == 'phone' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                            –¢–µ–ª–µ—Ñ–æ–Ω
                            <span class="sort-indicator {% if sort == 'phone' %}active{% endif %}">
                                {% if sort == 'phone' and order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            </span>
                        </a>
                    </th>
                    <th>
                        <a href="?page={{ current_page }}&search={{ filters.search }}&role={{ filters.role }}&status={{ filters.status }}&sort=role&order={% if sort == 'role' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                            –†–æ–ª—å
                            <span class="sort-indicator {% if sort == 'role' %}active{% endif %}">
                                {% if sort == 'role' and order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            </span>
                        </a>
                    </th>
                    <th>
                        <a href="?page={{ current_page }}&search={{ filters.search }}&role={{ filters.role }}&status={{ filters.status }}&sort=class&order={% if sort == 'class' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                            –ö–ª–∞—Å—Å
                            <span class="sort-indicator {% if sort == 'class' %}active{% endif %}">
                                {% if sort == 'class' and order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            </span>
                        </a>
                    </th>
                    <th>
                        <a href="?page={{ current_page }}&search={{ filters.search }}&role={{ filters.role }}&status={{ filters.status }}&sort=is_blocked&order={% if sort == 'is_blocked' and order == 'asc' %}desc{% else %}asc{% endif %}" class="sort-link">
                            –°—Ç–∞—Ç—É—Å
                            <span class="sort-indicator {% if sort == 'is_blocked' %}active{% endif %}">
                                {% if sort == 'is_blocked' and order == 'asc' %}‚ñ≤{% else %}‚ñº{% endif %}
                            </span>
                        </a>
                    </th>
                    <th>–í–∑—è—Ç–æ –∫–Ω–∏–≥</th>
                    <th>–û—Ç–∑—ã–≤–æ–≤</th>
                    <th>–ü–æ—Å–ª–µ–¥–Ω—è—è –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                <tr>
                    <td>{{ user[0] }}</td>
                    <td>{{ user[1] }}</td>
                    <td>{{ user[2] or '-' }}</td>
                    <td>{{ user[3] or '-' }}</td>
                    <td>
                        {% if user[4] == 'admin' %}
                            <span class="badge bg-primary">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</span>
                        {% elif user[4] == 'teacher' %}
                            <span class="badge bg-info">–£—á–∏—Ç–µ–ª—å</span>
                        {% else %}
                            <span class="badge bg-secondary">–£—á–µ–Ω–∏–∫</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user[9] %}
                            {{ user[9] }}
                        {% else %}
                            <span class="text-muted">-</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if user[8] == 1 %}
                            <span class="badge bg-danger">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω</span>
                        {% else %}
                            <span class="badge bg-success">–ê–∫—Ç–∏–≤–µ–Ω</span>
                        {% endif %}
                    </td>
                    <td>{{ user[5] }}</td>
                    <td>{{ user[6] }}</td>
                    <td>{{ user[7] or '–ù–µ—Ç –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏' }}</td>
                    <td>
                        {% if user[4] != 'admin' %}
                        <button type="button" 
                                class="btn btn-sm btn-primary me-1"
                                onclick="editUser({{ user[0] }}, '{{ user[1] }}', '{{ user[2] }}', '{{ user[3] }}', '{{ user[4] }}', '{{ user[9] }}')"
                                data-bs-toggle="tooltip" 
                                title="–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å">
                            ‚úèÔ∏è
                        </button>
                        <button type="button" 
                                class="btn btn-sm {% if user[8] == 1 %}btn-success{% else %}btn-danger{% endif %}"
                                data-bs-toggle="modal" 
                                data-bs-target="#blockModal{{ user[0] }}"
                                data-bs-tooltip="tooltip" 
                                title="{% if user[8] == 1 %}–†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å{% else %}–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å{% endif %}">
                            {% if user[8] == 1 %}
                                üîì
                            {% else %}
                                üîí
                            {% endif %}
                        </button>
                        
                        <!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è -->
                        <div class="modal fade" id="blockModal{{ user[0] }}" tabindex="-1">
                            <div class="modal-dialog">
                                <div class="modal-content">
                                    <div class="modal-header">
                                        <h5 class="modal-title">
                                            {% if user[8] == 1 %}
                                                –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                            {% else %}
                                                –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                                            {% endif %}
                                        </h5>
                                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                                    </div>
                                    <form action="/users/{{ user[0] }}/toggle_block" method="post">
                                        <div class="modal-body">
                                            <div class="mb-3">
                                                <label class="form-label">–ü—Ä–∏—á–∏–Ω–∞:</label>
                                                <textarea name="reason" class="form-control" required></textarea>
                                            </div>
                                        </div>
                                        <div class="modal-footer">
                                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                                            <button type="submit" class="btn {% if user[8] == 1 %}btn-success{% else %}btn-danger{% endif %}">
                                                {% if user[8] == 1 %}
                                                    –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                                {% else %}
                                                    –ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å
                                                {% endif %}
                                            </button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                        {% endif %}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    
    <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
    {% if total_pages > 1 %}
    <nav aria-label="Page navigation">
        <ul class="pagination justify-content-center">
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="?page=1&search={{ filters.search }}&role={{ filters.role }}&status={{ filters.status }}&sort={{ sort }}&order={{ order }}" aria-label="First">
                    <span aria-hidden="true">¬´¬´</span>
                </a>
            </li>
            <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                <a class="page-link" href="?page={{ current_page - 1 }}&search={{ filters.search }}&role={{ filters.role }}&status={{ filters.status }}&sort={{ sort }}&order={{ order }}" aria-label="Previous">
                    <span aria-hidden="true">¬´</span>
                </a>
            </li>
            
            {% for page in range(max(1, current_page - 2), min(total_pages + 1, current_page + 3)) %}
            <li class="page-item {% if page == current_page %}active{% endif %}">
                <a class="page-link" href="?page={{ page }}&search={{ filters.search }}&role={{ filters.role }}&status={{ filters.status }}&sort={{ sort }}&order={{ order }}">{{ page }}</a>
            </li>
            {% endfor %}
            
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="?page={{ current_page + 1 }}&search={{ filters.search }}&role={{ filters.role }}&status={{ filters.status }}&sort={{ sort }}&order={{ order }}" aria-label="Next">
                    <span aria-hidden="true">¬ª</span>
                </a>
            </li>
            <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                <a class="page-link" href="?page={{ total_pages }}&search={{ filters.search }}&role={{ filters.role }}&status={{ filters.status }}&sort={{ sort }}&order={{ order }}" aria-label="Last">
                    <span aria-hidden="true">¬ª¬ª</span>
                </a>
            </li>
        </ul>
    </nav>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è -->
<div class="modal fade" id="editUserModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="editUserForm">
                <div class="modal-body">
                    <input type="hidden" id="editUserId" name="user_id">
                    <div class="mb-3">
                        <label class="form-label">–ò–º—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è</label>
                        <input type="text" class="form-control" id="editUsername" name="username">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–§–ò–û</label>
                        <input type="text" class="form-control" id="editFullName" name="full_name">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                        <input type="text" class="form-control" id="editPhone" name="phone">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–†–æ–ª—å</label>
                        <select class="form-select" id="editRole" name="role">
                            <option value="user">–£—á–µ–Ω–∏–∫</option>
                            <option value="teacher">–£—á–∏—Ç–µ–ª—å</option>
                            <option value="admin">–ê–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">–ö–ª–∞—Å—Å</label>
                        <input type="text" class="form-control" id="editClass" name="class">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
// –û—Ç–ª–∞–¥–∫–∞ —Ñ–æ—Ä–º—ã —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
document.getElementById('filterForm').addEventListener('submit', function(e) {
    console.log('Form submitted with values:', {
        search: this.elements.search.value,
        role: this.elements.role.value,
        status: this.elements.status.value
    });
});

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏
function toggleSort(field) {
    const urlParams = new URLSearchParams(window.location.search);
    const currentSort = urlParams.get('sort') || 'id';
    const currentOrder = urlParams.get('order') || 'desc';
    
    let newOrder = 'asc';
    if (field === currentSort && currentOrder === 'asc') {
        newOrder = 'desc';
    }
    
    urlParams.set('sort', field);
    urlParams.set('order', newOrder);
    
    window.location.href = '?' + urlParams.toString();
}

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤
document.addEventListener('DOMContentLoaded', function() {
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-tooltip="tooltip"]'));
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl);
    });
});

function editUser(id, username, fullName, phone, role, className) {
    // –ó–∞–ø–æ–ª–Ω—è–µ–º —Ñ–æ—Ä–º—É –¥–∞–Ω–Ω—ã–º–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    document.getElementById('editUserId').value = id;
    document.getElementById('editUsername').value = username || '';
    document.getElementById('editFullName').value = fullName || '';
    document.getElementById('editPhone').value = phone || '';
    document.getElementById('editRole').value = role || 'user';
    document.getElementById('editClass').value = className || '';
    
    // –û—Ç–∫—Ä—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('editUserModal'));
    modal.show();
}

// –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Ñ–æ—Ä–º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
document.getElementById('editUserForm').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const userId = document.getElementById('editUserId').value;
    const formData = new FormData(this);
    
    fetch(`/users/${userId}/edit`, {
        method: 'POST',
        body: formData
    })
    .then(response => {
        if (response.ok) {
            showToast('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            return response.json().then(data => {
                throw new Error(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
            });
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast(error.message, 'error');
    });
});

function uploadExcel(input) {
    if (!input.files || !input.files[0]) return;
    
    const formData = new FormData();
    formData.append('file', input.files[0]);
    
    fetch('/admin/users/upload', {
        method: 'POST',
        body: formData
    }).then(response => {
        if (response.ok) {
            showToast('–§–∞–π–ª —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞', 'error');
            alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
        }
    }).catch(error => {
        console.error('Error:', error);
        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞', 'error');
        alert('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Ñ–∞–π–ª–∞');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showToast(message, type = 'success') {
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-primary';
    
    const toastHTML = `
        <div id="${toastId}" class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="3000">
            <div class="toast-header ${bgClass} text-white">
                <strong class="me-auto">${type === 'success' ? '–£—Å–ø–µ—à–Ω–æ' : type === 'error' ? '–û—à–∏–±–∫–∞' : '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ'}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    document.getElementById('toast-container').insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById(toastId);
    
    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è Toast
    try {
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', e);
        // –ï—Å–ª–∏ Bootstrap Toast –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–æ–±–∞–≤–∏–º –∫–ª–∞—Å—Å show –≤—Ä—É—á–Ω—É—é
        toastElement.classList.add('show');
        
        // –ò —É–¥–∞–ª–∏–º –µ–≥–æ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            toastElement.remove();
        }, 3000);
    }
    
    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è
    toastElement.addEventListener('hidden.bs.toast', function () {
        toastElement.remove();
    });
}
</script>
{% endblock %} 