{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏ - Library Admin{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="mb-0">
            <span class="text-danger">‚è±Ô∏è</span> –ü—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã–µ –∫–Ω–∏–≥–∏
        </h2>
        <a href="/books" class="btn btn-outline-primary">
            <i class="fas fa-arrow-left"></i> –ù–∞–∑–∞–¥ –∫ –∫–Ω–∏–≥–∞–º
        </a>
    </div>

    <!-- –§–∏–ª—å—Ç—Ä—ã -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" action="/overdue-books">
                <div class="row g-3">
                    <div class="col-md-4">
                        <label for="search" class="form-label">–ü–æ–∏—Å–∫ –ø–æ –Ω–∞–∑–≤–∞–Ω–∏—é/–∞–≤—Ç–æ—Ä—É/—É—á–µ–Ω–∏–∫—É</label>
                        <input type="text" class="form-control" id="search" name="search" value="{{ search_query }}">
                    </div>
                    <div class="col-md-3">
                        <label for="class_filter" class="form-label">–ö–ª–∞—Å—Å</label>
                        <select class="form-select" id="class_filter" name="class">
                            <option value="">–í—Å–µ –∫–ª–∞—Å—Å—ã</option>
                            {% for class_name in classes %}
                                <option value="{{ class_name }}" {% if class_filter == class_name %}selected{% endif %}>{{ class_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label for="days_overdue" class="form-label">–î–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–∫–∏</label>
                        <select class="form-select" id="days_overdue" name="days">
                            <option value="">–õ—é–±–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ</option>
                            <option value="7" {% if days_filter == 7 %}selected{% endif %}>–ë–æ–ª–µ–µ 7 –¥–Ω–µ–π</option>
                            <option value="14" {% if days_filter == 14 %}selected{% endif %}>–ë–æ–ª–µ–µ 14 –¥–Ω–µ–π</option>
                            <option value="30" {% if days_filter == 30 %}selected{% endif %}>–ë–æ–ª–µ–µ 30 –¥–Ω–µ–π</option>
                        </select>
                    </div>
                    <div class="col-md-2 d-flex align-items-end">
                        <button type="submit" class="btn btn-primary w-100">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    {% if overdue_books %}
        <div class="alert alert-info">
            –ü–æ–∫–∞–∑–∞–Ω–æ {{ overdue_books|length }} –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–Ω–∏–≥ –∏–∑ {{ total_overdue }} –≤—Å–µ–≥–æ
        </div>

        <!-- –¢–∞–±–ª–∏—Ü–∞ –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–Ω–∏–≥ -->
        <div class="table-responsive">
            <table class="table table-striped table-hover">
                <thead class="table-light">
                    <tr>
                        <th scope="col">–ù–∞–∑–≤–∞–Ω–∏–µ –∫–Ω–∏–≥–∏</th>
                        <th scope="col">–ê–≤—Ç–æ—Ä</th>
                        <th scope="col">–§–ò–û —É—á–µ–Ω–∏–∫–∞</th>
                        <th scope="col">–ö–ª–∞—Å—Å</th>
                        <th scope="col">–î–∞—Ç–∞ –≤—ã–¥–∞—á–∏</th>
                        <th scope="col">–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</th>
                        <th scope="col" class="text-danger">–î–Ω–µ–π –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–æ</th>
                        <!-- <th scope="col">–î–µ–π—Å—Ç–≤–∏—è</th> -->
                    </tr>
                </thead>
                <tbody>
                    {% for book in overdue_books %}
                    <tr>
                        <td>{{ book.title }}</td>
                        <td>{{ book.author }}</td>
                        <td>{{ book.student_name }}</td>
                        <td>{{ book.class }}</td>
                        <td>{{ book.borrow_date }}</td>
                        <td>{{ book.return_date }}</td>
                        <td class="text-danger fw-bold">{{ book.days_overdue }}</td>
                        <!-- <td>
                            <div class="btn-group btn-group-sm">
                                <button 
                                    class="btn btn-success" 
                                    onclick="markAsReturned({{ book.borrowed_id }})" 
                                    data-bs-toggle="tooltip" 
                                    title="–û—Ç–º–µ—Ç–∏—Ç—å –∫–∞–∫ –≤–æ–∑–≤—Ä–∞—â—ë–Ω–Ω—É—é">
                                    ‚úì
                                </button>
                                <button 
                                    class="btn btn-primary" 
                                    onclick="extendReturnDate({{ book.borrowed_id }})" 
                                    data-bs-toggle="tooltip" 
                                    title="–ü—Ä–æ–¥–ª–∏—Ç—å —Å—Ä–æ–∫">
                                    üóìÔ∏è
                                </button>
                                <button 
                                    class="btn btn-warning" 
                                    onclick="sendReminder({{ book.user_id }}, {{ book.borrowed_id }})" 
                                    data-bs-toggle="tooltip" 
                                    title="–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ">
                                    üì©
                                </button>
                            </div>
                        </td> -->
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- –ü–∞–≥–∏–Ω–∞—Ü–∏—è -->
        {% if total_pages > 1 %}
        <nav aria-label="Page navigation" class="mt-4">
            <ul class="pagination justify-content-center">
                <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="?page=1&search={{ search_query }}&class={{ class_filter }}&days={{ days_filter }}" aria-label="First">
                        <span aria-hidden="true">¬´¬´</span>
                    </a>
                </li>
                <li class="page-item {% if current_page == 1 %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ current_page - 1 }}&search={{ search_query }}&class={{ class_filter }}&days={{ days_filter }}" aria-label="Previous">
                        <span aria-hidden="true">¬´</span>
                    </a>
                </li>
                
                {% for page in range(max(1, current_page - 2), min(total_pages + 1, current_page + 3)) %}
                <li class="page-item {% if page == current_page %}active{% endif %}">
                    <a class="page-link" href="?page={{ page }}&search={{ search_query }}&class={{ class_filter }}&days={{ days_filter }}">{{ page }}</a>
                </li>
                {% endfor %}
                
                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ current_page + 1 }}&search={{ search_query }}&class={{ class_filter }}&days={{ days_filter }}" aria-label="Next">
                        <span aria-hidden="true">¬ª</span>
                    </a>
                </li>
                <li class="page-item {% if current_page == total_pages %}disabled{% endif %}">
                    <a class="page-link" href="?page={{ total_pages }}&search={{ search_query }}&class={{ class_filter }}&days={{ days_filter }}" aria-label="Last">
                        <span aria-hidden="true">¬ª¬ª</span>
                    </a>
                </li>
            </ul>
        </nav>
        {% endif %}
    {% else %}
        <div class="alert alert-success">
            <i class="fas fa-check-circle"></i> –ù–∞ –¥–∞–Ω–Ω—ã–π –º–æ–º–µ–Ω—Ç –Ω–µ—Ç –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –∫–Ω–∏–≥.
        </div>
    {% endif %}
</div>

<!-- –ú–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ –¥–ª—è –ø—Ä–æ–¥–ª–µ–Ω–∏—è —Å—Ä–æ–∫–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ -->
<div class="modal fade" id="extendDateModal" tabindex="-1" aria-labelledby="extendDateModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="extendDateModalLabel">–ü—Ä–æ–¥–ª–∏—Ç—å —Å—Ä–æ–∫ –≤–æ–∑–≤—Ä–∞—Ç–∞</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="extendDateForm">
                    <input type="hidden" id="borrowed_id_extend" name="borrowed_id">
                    <div class="mb-3">
                        <label for="new_return_date" class="form-label">–ù–æ–≤–∞—è –¥–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞</label>
                        <input type="date" class="form-control" id="new_return_date" name="new_return_date" required>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">–û—Ç–º–µ–Ω–∞</button>
                <button type="button" class="btn btn-primary" onclick="submitExtendDate()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
            </div>
        </div>
    </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Ç—É–ª—Ç–∏–ø–æ–≤
    var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'))
    var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
        return new bootstrap.Tooltip(tooltipTriggerEl)
    });
});

function markAsReturned(borrowedId) {
    if (confirm('–û—Ç–º–µ—Ç–∏—Ç—å –∫–Ω–∏–≥—É –∫–∞–∫ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω—É—é?')) {
        fetch(`/borrowed-books/${borrowedId}/return`, {
            method: 'POST'
        })
        .then(response => {
            if (response.ok) {
                showToast('–ö–Ω–∏–≥–∞ —É—Å–ø–µ—à–Ω–æ –æ—Ç–º–µ—á–µ–Ω–∞ –∫–∞–∫ –≤–æ–∑–≤—Ä–∞—â–µ–Ω–Ω–∞—è', 'success');
                setTimeout(() => location.reload(), 1500);
            } else {
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç–∞—Ç—É—Å–∞ –∫–Ω–∏–≥–∏', 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞', 'error');
        });
    }
}

function extendReturnDate(borrowedId) {
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è borrowed_id –≤ —Ñ–æ—Ä–º–µ
    document.getElementById('borrowed_id_extend').value = borrowedId;
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –¥–∞—Ç—ã –Ω–∞ –∑–∞–≤—Ç—Ä–∞
    const tomorrow = new Date();
    tomorrow.setDate(tomorrow.getDate() + 1);
    const minDate = tomorrow.toISOString().split('T')[0];
    document.getElementById('new_return_date').min = minDate;
    
    // –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–Ω–∞—á–µ–Ω–∏—è –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –Ω–∞ –¥–≤–µ –Ω–µ–¥–µ–ª–∏ –≤–ø–µ—Ä–µ–¥
    const twoWeeksLater = new Date();
    twoWeeksLater.setDate(twoWeeksLater.getDate() + 14);
    const defaultDate = twoWeeksLater.toISOString().split('T')[0];
    document.getElementById('new_return_date').value = defaultDate;
    
    // –ü–æ–∫–∞–∑–∞—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = new bootstrap.Modal(document.getElementById('extendDateModal'));
    modal.show();
}

function submitExtendDate() {
    const borrowedId = document.getElementById('borrowed_id_extend').value;
    const newReturnDate = document.getElementById('new_return_date').value;
    
    fetch(`/borrowed-books/${borrowedId}/extend`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            new_return_date: newReturnDate
        })
    })
    .then(response => {
        if (response.ok) {
            showToast('–î–∞—Ç–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞ —É—Å–ø–µ—à–Ω–æ –ø—Ä–æ–¥–ª–µ–Ω–∞', 'success');
            setTimeout(() => location.reload(), 1500);
        } else {
            showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø—Ä–æ–¥–ª–µ–Ω–∏–∏ –¥–∞—Ç—ã –≤–æ–∑–≤—Ä–∞—Ç–∞', 'error');
        }
    })
    .catch(error => {
        console.error('–û—à–∏–±–∫–∞:', error);
        showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞', 'error');
    });
    
    // –ó–∞–∫—Ä—ã—Ç—å –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    const modal = bootstrap.Modal.getInstance(document.getElementById('extendDateModal'));
    modal.hide();
}

function sendReminder(userId, borrowedId) {
    if (confirm('–û—Ç–ø—Ä–∞–≤–∏—Ç—å –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—á–µ–Ω–∏–∫—É –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ –≤–µ—Ä–Ω—É—Ç—å –∫–Ω–∏–≥—É?')) {
        fetch(`/users/${userId}/send-reminder`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                borrowed_id: borrowedId
            })
        })
        .then(response => {
            if (response.ok) {
                showToast('–ù–∞–ø–æ–º–∏–Ω–∞–Ω–∏–µ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ', 'success');
            } else {
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ –Ω–∞–ø–æ–º–∏–Ω–∞–Ω–∏—è', 'error');
            }
        })
        .catch(error => {
            console.error('–û—à–∏–±–∫–∞:', error);
            showToast('–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ —Å–µ—Ç–∏ –∏–ª–∏ —Å–µ—Ä–≤–µ—Ä–∞', 'error');
        });
    }
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showToast(message, type = 'success') {
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : type === 'error' ? 'bg-danger' : 'bg-primary';
    
    const toastHTML = `
        <div id="${toastId}" class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="3000">
            <div class="toast-header ${bgClass} text-white">
                <strong class="me-auto">${type === 'success' ? '–£—Å–ø–µ—à–Ω–æ' : type === 'error' ? '–û—à–∏–±–∫–∞' : '–£–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ'}</strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    document.getElementById('toast-container').insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById(toastId);
    
    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è Toast
    try {
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', e);
        // –ï—Å–ª–∏ Bootstrap Toast –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–æ–±–∞–≤–∏–º –∫–ª–∞—Å—Å show –≤—Ä—É—á–Ω—É—é
        toastElement.classList.add('show');
        
        // –ò —É–¥–∞–ª–∏–º –µ–≥–æ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            toastElement.remove();
        }, 3000);
    }
    
    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è
    toastElement.addEventListener('hidden.bs.toast', function () {
        toastElement.remove();
    });
}
</script>
{% endblock %} 