{% extends "base.html" %}

{% block title %}–ü—Ä–æ—Ñ–∏–ª—å —à–∫–æ–ª—ã - –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å –±–∏–±–ª–∏–æ—Ç–µ–∫–∏{% endblock %}

{% block content %}
<div class="container mt-4">
    <!-- –ó–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∫–Ω–æ–ø–∫–∏ -->
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>–ü—Ä–æ—Ñ–∏–ª—å —à–∫–æ–ª—ã</h1>
        <div>
            <button type="button" class="btn btn-primary" id="saveChanges">
                üíæ –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏—è
            </button>
        </div>
    </div>
    
    <div class="row">
        <!-- –õ–æ–≥–æ—Ç–∏–ø —à–∫–æ–ª—ã -->
        <div class="col-md-4 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">–õ–æ–≥–æ—Ç–∏–ø —à–∫–æ–ª—ã</h5>
                </div>
                <div class="card-body text-center">
                    <div class="mb-4">
                        {% if school.logo_url %}
                            <img src="{{ school.logo_url }}" alt="–õ–æ–≥–æ—Ç–∏–ø —à–∫–æ–ª—ã" class="img-fluid mb-3" style="max-height: 200px;">
                        {% else %}
                            <div class="border p-5 mb-3 text-muted">
                                <i class="fas fa-school" style="font-size: 5rem;">üè´</i>
                                <p>–õ–æ–≥–æ—Ç–∏–ø –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω</p>
                            </div>
                        {% endif %}
                    </div>
                    
                    <div class="mt-3">
                        <form id="logoForm">
                            <div class="input-group">
                                <input type="file" class="form-control" id="schoolLogo" name="logo" accept="image/*">
                                <button class="btn btn-primary" type="button" id="uploadLogo">–ó–∞–≥—Ä—É–∑–∏—Ç—å</button>
                            </div>
                            <small class="form-text text-muted">–†–µ–∫–æ–º–µ–Ω–¥—É–µ–º—ã–π —Ä–∞–∑–º–µ—Ä: 300x300 –ø–∏–∫—Å–µ–ª–µ–π</small>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —à–∫–æ–ª–µ -->
        <div class="col-md-8 mb-4">
            <div class="card h-100">
                <div class="card-header bg-primary text-white">
                    <h5 class="card-title mb-0">–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —à–∫–æ–ª–µ</h5>
                </div>
                <div class="card-body">
                    <form id="schoolInfoForm">
                        <div class="mb-3">
                            <label for="schoolName" class="form-label">–ù–∞–∑–≤–∞–Ω–∏–µ —É—á–µ–±–Ω–æ–≥–æ –∑–∞–≤–µ–¥–µ–Ω–∏—è</label>
                            <input type="text" class="form-control" id="schoolName" name="name" value="{{ school.name|default('') }}" required>
                        </div>
                        <div class="mb-3">
                            <label for="schoolType" class="form-label">–¢–∏–ø —É—á—Ä–µ–∂–¥–µ–Ω–∏—è</label>
                            <select class="form-select" id="schoolType" name="type">
                                <option value="school" {% if school.type == 'school' %}selected{% endif %}>–û–±—â–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç–µ–ª—å–Ω–∞—è —à–∫–æ–ª–∞</option>
                                <option value="gymnasium" {% if school.type == 'gymnasium' %}selected{% endif %}>–ì–∏–º–Ω–∞–∑–∏—è</option>
                                <option value="lyceum" {% if school.type == 'lyceum' %}selected{% endif %}>–õ–∏—Ü–µ–π</option>
                                <option value="college" {% if school.type == 'college' %}selected{% endif %}>–ö–æ–ª–ª–µ–¥–∂</option>
                                <option value="university" {% if school.type == 'university' %}selected{% endif %}>–£–Ω–∏–≤–µ—Ä—Å–∏—Ç–µ—Ç</option>
                                <option value="other" {% if school.type == 'other' %}selected{% endif %}>–î—Ä—É–≥–æ–µ</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="schoolAddress" class="form-label">–ê–¥—Ä–µ—Å</label>
                            <input type="text" class="form-control" id="schoolAddress" name="address" value="{{ school.address|default('') }}">
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="schoolPhone" class="form-label">–¢–µ–ª–µ—Ñ–æ–Ω</label>
                                    <input type="tel" class="form-control" id="schoolPhone" name="phone" value="{{ school.phone|default('') }}">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="schoolEmail" class="form-label">Email</label>
                                    <input type="email" class="form-control" id="schoolEmail" name="email" value="{{ school.email|default('') }}">
                                </div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <label for="schoolWebsite" class="form-label">–°–∞–π—Ç</label>
                            <input type="url" class="form-control" id="schoolWebsite" name="website" value="{{ school.website|default('') }}">
                        </div>
                        <div class="mb-3">
                            <label for="schoolDirector" class="form-label">–î–∏—Ä–µ–∫—Ç–æ—Ä</label>
                            <input type="text" class="form-control" id="schoolDirector" name="director" value="{{ school.director|default('') }}">
                        </div>
                        <div class="mb-3">
                            <label for="schoolDescription" class="form-label">–û–ø–∏—Å–∞–Ω–∏–µ</label>
                            <textarea class="form-control" id="schoolDescription" name="description" rows="4">{{ school.description|default('') }}</textarea>
                            <small class="form-text text-muted">–ö—Ä–∞—Ç–∫–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —à–∫–æ–ª–µ, –∫–æ—Ç–æ—Ä–∞—è –±—É–¥–µ—Ç –æ—Ç–æ–±—Ä–∞–∂–∞—Ç—å—Å—è –≤ —Ñ—É—Ç–µ—Ä–µ —Å–∞–π—Ç–∞ –±–∏–±–ª–∏–æ—Ç–µ–∫–∏</small>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <!-- –û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card">
                <div class="card-header bg-info text-white">
                    <h5 class="card-title mb-0">–û–±—â–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3 mb-3">
                            <div class="border rounded p-3 text-center">
                                <h6>–£—á–∞—â–∏—Ö—Å—è</h6>
                                <h2 class="mb-0">{{ stats.students_count|default('0') }}</h2>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="border rounded p-3 text-center">
                                <h6>–£—á–∏—Ç–µ–ª–µ–π</h6>
                                <h2 class="mb-0">{{ stats.teachers_count|default('0') }}</h2>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="border rounded p-3 text-center">
                                <h6>–ö–Ω–∏–≥</h6>
                                <h2 class="mb-0">{{ stats.books_count|default('0') }}</h2>
                            </div>
                        </div>
                        <div class="col-md-3 mb-3">
                            <div class="border rounded p-3 text-center">
                                <h6>–í—ã–¥–∞–Ω–æ –∫–Ω–∏–≥</h6>
                                <h2 class="mb-0">{{ stats.borrowed_books|default('0') }}</h2>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π -->
<div id="toast-container" class="position-fixed bottom-0 end-0 p-3" style="z-index: 11"></div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π
    document.getElementById('saveChanges').addEventListener('click', function() {
        saveSchoolInfo();
    });
    
    // –ó–∞–≥—Ä—É–∑–∫–∞ –ª–æ–≥–æ—Ç–∏–ø–∞
    document.getElementById('uploadLogo').addEventListener('click', function() {
        const logoInput = document.getElementById('schoolLogo');
        if (logoInput.files.length > 0) {
            const formData = new FormData();
            formData.append('logo', logoInput.files[0]);
            
            fetch('/admin/school/upload-logo', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showToast('–õ–æ–≥–æ—Ç–∏–ø —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω', 'success');
                    setTimeout(() => location.reload(), 1500);
                } else {
                    showToast(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ª–æ–≥–æ—Ç–∏–ø–∞', 'error');
                }
            })
            .catch(error => {
                console.error('Error:', error);
                showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ –ª–æ–≥–æ—Ç–∏–ø–∞', 'error');
            });
        } else {
            showToast('–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Ñ–∞–π–ª', 'warning');
        }
    });
});

function saveSchoolInfo() {
    const formData = new FormData(document.getElementById('schoolInfoForm'));
    
    fetch('/admin/school/update-info', {
        method: 'POST',
        body: formData
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —à–∫–æ–ª–µ —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞', 'success');
        } else {
            showToast(data.error || '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —à–∫–æ–ª–µ', 'error');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ —à–∫–æ–ª–µ', 'error');
    });
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π
function showToast(message, type = 'success') {
    const toastId = 'toast-' + Date.now();
    const bgClass = type === 'success' ? 'bg-success' : 
                     type === 'error' ? 'bg-danger' : 
                     type === 'warning' ? 'bg-warning' : 'bg-info';
    
    const toastHTML = `
        <div id="${toastId}" class="toast show" role="alert" aria-live="assertive" aria-atomic="true" data-bs-autohide="true" data-bs-delay="3000">
            <div class="toast-header ${bgClass} text-white">
                <strong class="me-auto">
                    ${type === 'success' ? '–£—Å–ø–µ—à–Ω–æ' : 
                      type === 'error' ? '–û—à–∏–±–∫–∞' : 
                      type === 'warning' ? '–ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ' : '–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è'}
                </strong>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body">
                ${message}
            </div>
        </div>
    `;
    
    document.getElementById('toast-container').insertAdjacentHTML('beforeend', toastHTML);
    const toastElement = document.getElementById(toastId);
    
    // –ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π —Å–ø–æ—Å–æ–± –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è Toast
    try {
        const toast = new bootstrap.Toast(toastElement);
        toast.show();
    } catch (e) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–∏ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è:', e);
        // –ï—Å–ª–∏ Bootstrap Toast –Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç, –¥–æ–±–∞–≤–∏–º –∫–ª–∞—Å—Å show –≤—Ä—É—á–Ω—É—é
        toastElement.classList.add('show');
        
        // –ò —É–¥–∞–ª–∏–º –µ–≥–æ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
        setTimeout(() => {
            toastElement.remove();
        }, 3000);
    }
    
    // –£–¥–∞–ª—è–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –ø–æ—Å–ª–µ —Å–∫—Ä—ã—Ç–∏—è
    toastElement.addEventListener('hidden.bs.toast', function () {
        toastElement.remove();
    });
}
</script>
{% endblock %} 